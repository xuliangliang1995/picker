# 不变模式(`Immutable Pattern`)
![](https://picker-oss.oss-cn-beijing.aliyuncs.com/20200210/87cd7a6a9c080fb2495f963edb174c72.png_target)

一个对象的状态在被创建之后就不再变化，这就是所谓的不变模式。

不变模式缺少改变自身状态的行为，因此它是关于行为的，归属为行为模式。

## 强不变模式与弱不变模式

**弱不变模式**：一个类的实例自身的状态是不可变化的，但是这个类的子类的实例具有可变的状态。

要实现弱不变模式，一个类必须满足以下条件：

1. 所考虑的对象没有任何方法会修改对象的状态。当对象通过构造器将对象的状态初始化之后，对象的状态便不再改变。
2. 所有的属性都应当是私有的。不要声明任何公开的属性，防止被客户端更改。
3. 如果这个对象所引用的其他对象如果是可变对象的话，必须设法限制外界对这些可变对象的访问，以防止外界修改这些状态。如果可能，应当尽量在不变对象内部初始化这些被引用的对象，而不要在客户端初始化。

弱不变模式的显著缺点，就是允许子类是可变的。而可变的子对象可能可以修改父对象的状态。

**强不变模式**：一个类的实例自身的状态不会改变，同时它的子类的实例的状态也不会改变。

要实现强不变模式，一个类还需要满足下面条件之一：

1. 所考虑的类的所有方法都应当是 `final`，这样这个类的子类不能置换掉此类的方法。
2. 这个类本身就是 `final` 的，那么这个类就不可能会有子类。

## “不变”和“只读”的区别

“不变”（`Immutable`）与“只读”（`Read Only`）是不同的。当一个变量是“只读”时，变量的值不能直接改变，但是可以在其他变量发生改变的时候发生变化。

比如，一个人的出生日期是“不变”属性，而年龄则是“只读”属性。年龄会随着时间的变化而变化。

## 强不变类`java.lang.String`

Java 中的 `String` 类型就是一个强不变类。`String` 对象在创建之后就不会再发生改变。

当出现如下语句时：

```java
String a = "hello world";
String b = "hello world";
String c = "hello world";
```

`JVM` 其实只会创建一个字符串的实例，而这三个 `String` 对象都在共享这一个值。正是因为 `String` 类型的不可变性，所以才能过这么做。无论对`a`,`b`,`c` 进行怎样操作，都不会影响到最初创建的字符串实例 `hello world`。

但同时也因为`String`类型的不变性，如果程序所处理的文字串有频繁的内容变化时，就不宜使用 `String` 类型。因为每一次变动都需要创建新的字符串对象。这个时候，应当考虑使用 `StringBuffer`类型。

## 不变模式的优缺点

**优点**：

1. 因为不能修改一个不变对象的状态，所以可以避免由此引起的不必要的程序错误。一个不变的对象要比可变的对象更加容易维护。
2. 因为没有任何一个线程能够修改不变对象的内部状态，一个不变对象自动就是线程安全的，这样可以省掉处理同步化的开销。

**缺点**：

1. 由于对象的不可变性。一旦需要修改一个对象的状态，就只好创建一个新的同类对象出来。如果频繁的操作，会产生大量的中间对象，再被垃圾回收器回收掉。这是一种资源上的浪费。